# ─────────────────────────────────────────────────────────────────────────────
# ci.yml — Continuous Integration
# Runs on every Pull Request targeting main.
# Validates: .NET build, Terraform fmt/validate, Docker build, container scan.
# ─────────────────────────────────────────────────────────────────────────────
name: CI — Build & Validate

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write       # Required for OIDC auth to Azure (Terraform validate)
  security-events: write # Required for uploading SARIF results

jobs:
  # ── 1. .NET Build & Test ───────────────────────────────────────────────────
  dotnet-build:
    name: .NET Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore src/PartsUnlimited.Web/PartsUnlimited.Web.csproj

      - name: Build
        run: dotnet build src/PartsUnlimited.Web/PartsUnlimited.Web.csproj --no-restore -c Release

      - name: Run tests (if test projects exist)
        run: |
          TEST_PROJS=$(find . -name "*.Tests.csproj" -o -name "*Tests.csproj" | head -5)
          if [ -n "$TEST_PROJS" ]; then
            dotnet test $TEST_PROJS --no-build -c Release --logger trx --results-directory ./test-results
          else
            echo "No test projects found — skipping unit tests."
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./test-results
          if-no-files-found: ignore

  # ── 2. Docker Build (no push on PRs) ──────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (validate only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/PartsUnlimited.Web/Dockerfile
          push: false
          tags: partsunlimited:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── 3. Container Security Scan (Trivy) ────────────────────────────────────
  security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - uses: actions/checkout@v4

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/PartsUnlimited.Web/Dockerfile
          push: false
          tags: partsunlimited:scan
          load: true

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: partsunlimited:scan
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  # ── 4. Terraform Validate ─────────────────────────────────────────────────
  terraform-validate:
    name: Terraform Format & Validate
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_USE_OIDC: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.7"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: infra

      - name: Terraform Init (local backend for validation)
        run: terraform init -backend=false
        working-directory: infra

      - name: Terraform Validate
        run: terraform validate
        working-directory: infra

  # ── 5. Dependency Audit ───────────────────────────────────────────────────
  dependency-audit:
    name: .NET Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Audit NuGet packages
        run: dotnet list src/PartsUnlimited.Web/PartsUnlimited.Web.csproj package --vulnerable --include-transitive
        continue-on-error: true
