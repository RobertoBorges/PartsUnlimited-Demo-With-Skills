@model PartsUnlimited.ViewModels.ShoppingCartViewModel
@{
    ViewData["Title"] = "Shopping Cart";
    var summary = ViewBag.OrderCostSummary as PartsUnlimited.Models.OrderCostSummary;
}
<h2>Shopping Cart</h2>

@if (!Model.CartItems.Any())
{
    <p>Your cart is empty. <a asp-controller="Store" asp-action="Index">Continue shopping</a>.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Unit Price</th>
                <th>Qty</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.CartItems)
            {
                <tr id="row-@item.CartItemId">
                    <td>@item.Product?.Title</td>
                    <td>@item.UnitPrice.ToString("C")</td>
                    <td>@item.Count</td>
                    <td>@((item.Count * item.UnitPrice).ToString("C"))</td>
                    <td>
                        <a href="#" class="remove-item" data-id="@item.CartItemId">Remove</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (summary != null)
    {
        <dl class="dl-horizontal">
            <dt>Subtotal</dt><dd>@summary.CartSubTotal</dd>
            <dt>Shipping</dt><dd>@summary.CartShipping</dd>
            <dt>Tax</dt><dd>@summary.CartTax</dd>
            <dt><strong>Total</strong></dt><dd><strong>@summary.CartTotal</strong></dd>
        </dl>
    }

    <a asp-controller="Checkout" asp-action="AddressAndPayment" class="btn btn-success btn-lg">Checkout</a>
}

@section scripts {
    <script>
        $("a.remove-item").click(function (e) {
            e.preventDefault();
            const id = $(this).data("id");
            $.post("/ShoppingCart/RemoveFromCart", { id: id, __RequestVerificationToken: $('input[name=__RequestVerificationToken]').val() })
              .done(function (r) {
                  if (r.itemCount === 0) $("#row-" + id).remove();
              });
        });
    </script>
}
